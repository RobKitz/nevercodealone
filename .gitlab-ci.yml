---
#--- STAGES ---------------------------------------------------------------------------------------
# build:      create docker images and dependencies
# test:       deploy staging environment to container host and run tests
# deploy:     deploy application to production
# teardown:   remove application (trigger: manual)
stages:
  - build
  - test
  - deploy
  - teardown


#--- JOBS -----------------------------------------------------------------------------------------

build:branch:
 stage: build
 image: docker
 before_script:
   - docker login --username gitlab-ci-token --password $CI_BUILD_TOKEN $CI_REGISTRY 2>/dev/null
 script:
   - docker build -t $CI_REGISTRY/$CI_PROJECT_PATH:$CI_COMMIT_REF_SLUG .
   - docker push $CI_REGISTRY/$CI_PROJECT_PATH:$CI_COMMIT_REF_SLUG
 tags:
   - docker-executor

test:app:
  stage: test
  image: registry.nevercodealone.de/nevercodealone/docker-codeception:gitlab-ci-integrated
  services:
    - name: mariadb
      alias: db
    - name: $CI_REGISTRY/$CI_PROJECT_PATH:$CI_COMMIT_REF_SLUG
      alias: nevercodealone
    - name: selenium/standalone-chrome
      alias: selenium
  variables:
    BROWSER_URL: http://nevercodealone
    DATABASE_URL: mysql://nca:nca@db/nca
    DB_HOST: db
    DB_NAME: nca
    DB_USER: nca
    DB_PASS: nca
    MYSQL_DATABASE: nca
    MYSQL_PASSWORD: nca
    MYSQL_ROOT_PASSWORD: nca
    MYSQL_USER: nca
    WEBDRIVER_URL: selenium:4444/wd/hub/
  script:
    - curl -L $BROWSER_URL
    - sleep 10
    - codecept build
    - codecept run -vvv

#deploy:staging:
#  stage: test
#  image: identt/rancher-compose
#  environment:
#    name: staging
#    url: "output.${CI_COMMIT_REF_SLUG}.${TRAEFIK_DOMAIN}"
#  variables:
#    CORS_ALLOW_ORIGIN: '^https?://(.*\.)?nevercodealone.de:?[0-9]*$$'
#    DATABASE_URL: mysql://nca:nca@db/nca
#    DATABASE_HOST: db
#    DATABASE_NAME: nca
#    DATABASE_USER: nca
#    DATABASE_PASS: nca
#    TRAEFIK_DOMAIN: "develop.nevercodealone.de"
#    TRAEFIK_URL: "${CI_COMMIT_REF_SLUG}.${TRAEFIK_DOMAIN}"
#    BROWSER_URL: "${CI_COMMIT_REF_SLUG}.${TRAEFIK_DOMAIN}"
#    OUTPUT_URL: "output.${CI_COMMIT_REF_SLUG}.${TRAEFIK_DOMAIN}"
#    WEBDRIVER_URL: selenium.stage.nevercodealone.de
#  script:
#    - rancher-compose -f docker-compose-ci.yml -p $CI_PROJECT_NAME-$CI_COMMIT_REF_SLUG rm -v -f
#    - rancher-compose -f docker-compose-ci.yml -p $CI_PROJECT_NAME-$CI_COMMIT_REF_SLUG up -d
#    - sleep 10
#    - curl -sSL "output.${CI_COMMIT_REF_SLUG}.${TRAEFIK_DOMAIN}/runtest"
#  tags:
#    - docker-executor
#  except:
#    - master

#teardown:
#  stage: teardown
#  image: identt/rancher-compose
#  script:
#    - rancher-compose -f docker-compose-ci.yml -p $CI_PROJECT_NAME-$CI_COMMIT_REF_SLUG rm -v -f
#  tags:
#    - docker-executor
#  when: manual

